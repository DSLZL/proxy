name: Proxy Speed Tester

on:
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00 (北京时间 6:00)
  workflow_dispatch:

env:
  SUBSCRIPTION_URL: "您的订阅链接"  # 替换为真实链接
  TEST_URL: "http://www.gstatic.com/generate_204"  # 测试用低负载URL
  TIMEOUT: 5  # 单次测试超时(秒)
  MAX_TEST: 20  # 最大测试数量(避免超时)

jobs:
  test-proxies:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl wget

    - name: Download and decode subscription
      run: |
        mkdir -p output
        # 下载订阅
        curl -s "$SUBSCRIPTION_URL" -o output/subscription.raw
        # 多重解码尝试
        base64 -d output/subscription.raw > output/decoded.txt 2>/dev/null || \
          cp output/subscription.raw output/decoded.txt
        # 提取vmess链接
        grep -o 'vmess://[^"<> ]*' output/decoded.txt | sort -u > output/vmess.txt
        echo "提取到 $(wc -l < output/vmess.txt) 个vmess链接"

    - name: Test proxies
      run: |
        # 过滤黑名单关键词
        BLACKLIST="${{ env.BLACKLIST_KEYWORDS }}"
        FILTERED_PROXIES=()
        while read -r LINE; do
          PS=$(echo "$LINE" | base64 -d 2>/dev/null | jq -r '.ps' || echo "")
          if [[ "$BLACKLIST" != "" && "$PS" =~ ($BLACKLIST) ]]; then
            echo "过滤: $PS (黑名单关键词)"
            continue
          fi
          FILTERED_PROXIES+=("$LINE")
        done < output/vmess.txt

        # 测试前N个代理
        echo -e "\n开始测试 ${#FILTERED_PROXIES[@]} 个代理..."
        VALID_PROXIES=()
        for ((i=0; i<${#FILTERED_PROXIES[@]} && i<$MAX_TEST; i++)); do
          LINK="${FILTERED_PROXIES[$i]}"
          echo -e "\n测试代理 $((i+1)): ${LINK:0:60}..."
          
          # 解析配置
          CONFIG=$(echo "${LINK:8}" | base64 -d 2>/dev/null | jq -c 2>/dev/null)
          if [[ -z "$CONFIG" ]]; then
            echo "❌ 无效的vmess配置"
            continue
          fi

          # 提取连接参数
          SERVER=$(jq -r '.add' <<< "$CONFIG")
          PORT=$(jq -r '.port' <<< "$CONFIG")
          
          # 直接测试TCP连通性
          if timeout $TIMEOUT nc -z -w $TIMEOUT "$SERVER" "$PORT"; then
            # 测试HTTP延迟
            START=$(date +%s%N)
            if curl -s -m $TIMEOUT "$TEST_URL" >/dev/null; then
              LATENCY=$((($(date +%s%N) - START)/1000000))
              echo "✅ 可用 - 延迟 ${LATENCY}ms"
              VALID_PROXIES+=("$LINK")
            else
              echo "❌ HTTP测试失败"
            fi
          else
            echo "❌ TCP连接失败"
          fi
        done

        # 保存结果
        if [[ ${#VALID_PROXIES[@]} -gt 0 ]]; then
          printf "%s\n" "${VALID_PROXIES[@]}" > output/valid.txt
          echo "有效代理: ${#VALID_PROXIES[@]} 个"
        else
          echo "empty" > output/valid.txt
          echo "⚠️ 未找到有效代理"
        fi

    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: proxy-results
        path: |
          output/valid.txt
          output/vmess.txt
          output/decoded.txt